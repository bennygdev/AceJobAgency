@page
@model AppSec_Assignment2.Pages.ForgotPasswordModel
@{
    ViewData["Title"] = "Forgot Password";
}

<div class="container mx-auto px-4 py-12">
    <div class="mx-auto max-w-md">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold tracking-tight">Forgot Password?</h1>
            <p class="mt-2 text-muted-foreground">No worries, we'll send you reset instructions</p>
        </div>

        <!-- Card -->
        <div class="card w-full">
            @if (Model.EmailSent)
            {
                <section class="py-8 text-center">
                    <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-green-100 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">Check your email</h3>
                    <p class="text-muted-foreground text-sm mb-6">If an account exists with this email address, we've sent password reset instructions.</p>
                    <p class="text-xs text-muted-foreground mb-6">Didn't receive the email? Check your spam folder or <a href="#" onclick="location.reload()" class="underline">try again</a>.</p>
                    <a asp-page="/Login" class="btn w-full">Back to Login</a>
                </section>
            }
            else
            {
                <header>
                    <h2>Reset Password</h2>
                    <p>Enter your email to receive a reset link</p>
                </header>
                <section>
                    <form method="post" id="forgotForm" class="form grid gap-6">
                        @Html.AntiForgeryToken()
                        
                        <div asp-validation-summary="ModelOnly" class="validation-summary-errors"></div>

                        <div class="grid gap-2">
                            <label asp-for="Input.Email">Email Address</label>
                            <input asp-for="Input.Email" type="email" placeholder="john.doe@example.com" />
                            <span asp-validation-for="Input.Email"></span>
                        </div>

                        <input type="hidden" asp-for="Input.ReCaptchaToken" id="recaptchaToken" />
                    </form>
                </section>
                <footer class="flex flex-col items-center gap-4">
                    <button type="submit" form="forgotForm" class="btn w-full" id="submitBtn">
                        <span id="btnText">Send Reset Link</span>
                        <span id="btnLoading" class="hidden flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                            Sending...
                        </span>
                    </button>
                    <a asp-page="/Login" class="text-sm text-muted-foreground hover:text-foreground">‚Üê Back to Login</a>
                </footer>
            }
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://www.google.com/recaptcha/api.js?render=@Model.ReCaptchaSiteKey"></script>
    <script>
        const siteKey = '@Model.ReCaptchaSiteKey';
        const form = document.getElementById('forgotForm');
        let isSubmitting = false;

        if (form) {
            form.addEventListener('submit', function(e) {
                if (isSubmitting) {
                    e.preventDefault();
                    return false;
                }

                // Check jQuery validation
                if (typeof $ !== 'undefined' && $.validator && !$(form).valid()) {
                    e.preventDefault();
                    return false;
                }

                if (siteKey && siteKey !== 'YOUR_RECAPTCHA_SITE_KEY' && typeof grecaptcha !== 'undefined') {
                    e.preventDefault();
                    isSubmitting = true;
                    document.getElementById('btnText').classList.add('hidden');
                    document.getElementById('btnLoading').classList.remove('hidden');
                    document.getElementById('submitBtn').disabled = true;

                    grecaptcha.ready(function() {
                        grecaptcha.execute(siteKey, {action: 'forgot_password'}).then(function(token) {
                            document.getElementById('recaptchaToken').value = token;
                            HTMLFormElement.prototype.submit.call(form);
                        }).catch(function(error) {
                            console.error('reCAPTCHA error:', error);
                            isSubmitting = false;
                            document.getElementById('btnText').classList.remove('hidden');
                            document.getElementById('btnLoading').classList.add('hidden');
                            document.getElementById('submitBtn').disabled = false;
                            HTMLFormElement.prototype.submit.call(form);
                        });
                    });
                    return false;
                }

                // Show loading state
                isSubmitting = true;
                document.getElementById('btnText').classList.add('hidden');
                document.getElementById('btnLoading').classList.remove('hidden');
            });
        }
    </script>
}
