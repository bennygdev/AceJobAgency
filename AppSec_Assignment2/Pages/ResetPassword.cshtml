@page
@model AppSec_Assignment2.Pages.ResetPasswordModel
@{
    ViewData["Title"] = "Reset Password";
}

<div class="container mx-auto px-4 py-12">
    <div class="mx-auto max-w-lg">
        @if (Model.ResetComplete)
        {
            <!-- Success State -->
            <div class="card w-full">
                <section class="py-8 text-center">
                    <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-green-100 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">Password Reset Successful</h3>
                    <p class="text-muted-foreground text-sm mb-6">Your password has been successfully reset. You can now log in with your new password.</p>
                    <a asp-page="/Login" class="btn w-full">Go to Login</a>
                </section>
            </div>
        }
        else if (!Model.TokenValid)
        {
            <!-- Invalid Token State -->
            <div class="card w-full">
                <section class="py-8 text-center">
                    <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-red-100 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">Invalid or Expired Link</h3>
                    <p class="text-muted-foreground text-sm mb-6">This password reset link is invalid or has expired. Please request a new one.</p>
                    <a asp-page="/ForgotPassword" class="btn w-full">Request New Link</a>
                </section>
            </div>
        }
        else
        {
            <!-- Header -->
            <div class="mb-8 text-center">
                <h1 class="text-3xl font-bold tracking-tight">Reset Password</h1>
                <p class="mt-2 text-muted-foreground">Create a new password for your account</p>
            </div>

            <!-- Card -->
            <div class="card w-full">
                <header>
                    <h2>New Password</h2>
                    <p>Choose a strong password for your account</p>
                </header>
                <section>
                    <form method="post" id="resetForm" class="form grid gap-6">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Input.Token" />
                        <input type="hidden" asp-for="Input.Email" />
                        
                        <div asp-validation-summary="ModelOnly" class="validation-summary-errors"></div>

                        <div class="grid gap-2">
                            <label asp-for="Input.NewPassword">New Password</label>
                            <div class="relative">
                                <input asp-for="Input.NewPassword" type="password" id="newPassword" placeholder="Enter new password" />
                                <button type="button" class="toggle-password absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground" data-target="newPassword">
                                    <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    <svg class="eye-off-icon hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                                </button>
                            </div>
                            <span asp-validation-for="Input.NewPassword"></span>
                            
                            <!-- Password Strength -->
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 h-1.5 rounded-full bg-muted overflow-hidden">
                                        <div id="strengthBar" class="h-full password-strength-bar w-0 transition-all"></div>
                                    </div>
                                    <span id="strengthText" class="text-xs text-muted-foreground min-w-16">Strength</span>
                                </div>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                                    <span id="req-length" class="requirement-unmet flex items-center gap-1"><span class="req-icon">○</span> 12+ characters</span>
                                    <span id="req-lower" class="requirement-unmet flex items-center gap-1"><span class="req-icon">○</span> Lowercase</span>
                                    <span id="req-upper" class="requirement-unmet flex items-center gap-1"><span class="req-icon">○</span> Uppercase</span>
                                    <span id="req-number" class="requirement-unmet flex items-center gap-1"><span class="req-icon">○</span> Number</span>
                                    <span id="req-special" class="requirement-unmet flex items-center gap-1"><span class="req-icon">○</span> Special char</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid gap-2">
                            <label asp-for="Input.ConfirmNewPassword">Confirm New Password</label>
                            <div class="relative">
                                <input asp-for="Input.ConfirmNewPassword" type="password" id="confirmPassword" placeholder="Confirm new password" />
                                <button type="button" class="toggle-password absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground" data-target="confirmPassword">
                                    <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    <svg class="eye-off-icon hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                                </button>
                            </div>
                            <span asp-validation-for="Input.ConfirmNewPassword"></span>
                            <p id="passwordMatch" class="text-sm"></p>
                        </div>
                    </form>
                </section>
                <footer>
                    <button type="submit" form="resetForm" class="btn w-full">Reset Password</button>
                </footer>
            </div>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');

        if (newPassword) {
            newPassword.addEventListener('input', function() {
                checkPasswordStrength(this.value);
                checkPasswordMatch();
            });
        }

        if (confirmPassword) {
            confirmPassword.addEventListener('input', checkPasswordMatch);
        }

        function checkPasswordStrength(pwd) {
            let strength = 0;
            const requirements = {
                'req-length': pwd.length >= 12,
                'req-lower': /[a-z]/.test(pwd),
                'req-upper': /[A-Z]/.test(pwd),
                'req-number': /\d/.test(pwd),
                'req-special': /[!@@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd)
            };

            Object.entries(requirements).forEach(([id, met]) => {
                const el = document.getElementById(id);
                if (!el) return;
                const icon = el.querySelector('.req-icon');
                if (met) {
                    strength++;
                    el.classList.remove('requirement-unmet');
                    el.classList.add('requirement-met');
                    icon.textContent = '✓';
                } else {
                    el.classList.remove('requirement-met');
                    el.classList.add('requirement-unmet');
                    icon.textContent = '○';
                }
            });

            const bar = document.getElementById('strengthBar');
            const text = document.getElementById('strengthText');
            if (!bar || !text) return;
            
            bar.style.width = (strength / 5 * 100) + '%';
            bar.className = 'h-full password-strength-bar w-0 transition-all';
            
            if (strength === 0) { text.textContent = 'Strength'; }
            else if (strength <= 2) { bar.classList.add('strength-weak'); text.textContent = 'Weak'; }
            else if (strength <= 3) { bar.classList.add('strength-fair'); text.textContent = 'Fair'; }
            else if (strength <= 4) { bar.classList.add('strength-good'); text.textContent = 'Good'; }
            else { bar.classList.add('strength-strong'); text.textContent = 'Strong'; }
        }

        function checkPasswordMatch() {
            const indicator = document.getElementById('passwordMatch');
            if (!indicator || !newPassword || !confirmPassword) return;
            
            if (confirmPassword.value.length === 0) {
                indicator.textContent = '';
                indicator.style.color = '';
            } else if (newPassword.value === confirmPassword.value) {
                indicator.textContent = '✓ Passwords match';
                indicator.style.color = '#22c55e';
                indicator.style.fontSize = '0.75rem';
            } else {
                indicator.textContent = '✗ Passwords do not match';
                indicator.style.color = '#dc2626';
                indicator.style.fontSize = '0.75rem';
            }
        }

        // Password visibility toggle with icon update
        document.querySelectorAll('.toggle-password').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                const eyeIcon = this.querySelector('.eye-icon');
                const eyeOffIcon = this.querySelector('.eye-off-icon');
                
                if (input && input.type === 'password') {
                    input.type = 'text';
                    eyeIcon.classList.add('hidden');
                    eyeOffIcon.classList.remove('hidden');
                } else if (input) {
                    input.type = 'password';
                    eyeIcon.classList.remove('hidden');
                    eyeOffIcon.classList.add('hidden');
                }
            });
        });
    </script>
}
