@page
@model AceJobAgency.Pages.LoginModel
@{
    ViewData["Title"] = "Login";
}

<div class="container mx-auto px-4 py-12">
    <div class="mx-auto max-w-md">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold tracking-tight">Welcome back</h1>
            <p class="mt-2 text-muted-foreground">Sign in to your account</p>
        </div>

        <!-- Success/Warning Messages -->
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="alert mb-6 h-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></svg>
                <div class="text-sm font-medium break-words">@Model.SuccessMessage</div>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.Message))
        {
            <div class="alert-destructive mb-6 h-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>
                <div class="text-sm font-medium break-words">@Model.Message</div>
            </div>
        }

        <!-- Card -->
        <div class="card w-full">
            <header>
                <h2>Sign In</h2>
                <p>Enter your credentials to access your account</p>
            </header>
            <section>
                <form method="post" id="loginForm" class="form grid gap-6">
                    @Html.AntiForgeryToken()
                    
                    <div asp-validation-summary="ModelOnly" class="validation-summary-errors"></div>

                    <div class="grid gap-2">
                        <label asp-for="Input.Email">Email Address</label>
                        <input asp-for="Input.Email" type="email" placeholder="john.doe@example.com" autocomplete="email" />
                        <span asp-validation-for="Input.Email"></span>
                    </div>

                    <div class="grid gap-2">
                        <div class="flex items-center gap-2">
                            <label asp-for="Input.Password">Password</label>
                            <a asp-page="/ForgotPassword" class="ml-auto inline-block text-sm underline-offset-4 hover:underline">Forgot password?</a>
                        </div>
                        <div class="relative">
                            <input asp-for="Input.Password" type="password" id="password" placeholder="Enter your password" autocomplete="current-password" />
                            <button type="button" id="togglePasswordBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground">
                                <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                <svg id="eyeOffIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                            </button>
                        </div>
                        <span asp-validation-for="Input.Password"></span>
                    </div>

                    <label class="flex items-center gap-2 text-sm font-normal">
                        <input asp-for="Input.RememberMe" type="checkbox" />
                        <span>Remember me</span>
                    </label>

                    <input type="hidden" asp-for="Input.ReCaptchaToken" id="recaptchaToken" />
                </form>
            </section>
            <footer class="flex flex-col items-center gap-4">
                <button type="submit" form="loginForm" class="btn w-full" id="submitBtn">
                    <span id="btnText">Sign In</span>
                    <span id="btnLoading" class="hidden flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                        Signing in...
                    </span>
                </button>
                <p class="text-center text-sm text-muted-foreground">
                    Don't have an account? <a asp-page="/Register" class="underline-offset-4 hover:underline font-medium">Create one</a>
                </p>
            </footer>
        </div>

        <!-- reCAPTCHA Notice -->
        <p class="mt-6 text-center text-xs text-muted-foreground">
            Protected by reCAPTCHA. 
            <a href="https://policies.google.com/privacy" target="_blank" class="underline">Privacy</a> Â· 
            <a href="https://policies.google.com/terms" target="_blank" class="underline">Terms</a>
        </p>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://www.google.com/recaptcha/api.js?render=@Model.ReCaptchaSiteKey"></script>
    <script>
        // Password visibility toggle with icon update
        const passwordInput = document.getElementById('password');
        const toggleBtn = document.getElementById('togglePasswordBtn');
        const eyeIcon = document.getElementById('eyeIcon');
        const eyeOffIcon = document.getElementById('eyeOffIcon');

        toggleBtn.addEventListener('click', function() {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
            }
        });

        const siteKey = '@Model.ReCaptchaSiteKey';
        const form = document.getElementById('loginForm');
        let isSubmitting = false;

        form.addEventListener('submit', function(e) {
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }

            // Check jQuery validation
            if (typeof $ !== 'undefined' && $.validator) {
                if (!$(form).valid()) {
                    e.preventDefault();
                    return false;
                }
            }

            // If reCAPTCHA is configured, handle it
            if (siteKey && siteKey !== 'YOUR_RECAPTCHA_SITE_KEY' && typeof grecaptcha !== 'undefined') {
                e.preventDefault();
                isSubmitting = true;
                document.getElementById('btnText').classList.add('hidden');
                document.getElementById('btnLoading').classList.remove('hidden');
                document.getElementById('submitBtn').disabled = true;

                grecaptcha.ready(function() {
                    grecaptcha.execute(siteKey, {action: 'login'}).then(function(token) {
                        document.getElementById('recaptchaToken').value = token;
                        HTMLFormElement.prototype.submit.call(form);
                    }).catch(function(error) {
                        console.error('reCAPTCHA error:', error);
                        isSubmitting = false;
                        document.getElementById('btnText').classList.remove('hidden');
                        document.getElementById('btnLoading').classList.add('hidden');
                        document.getElementById('submitBtn').disabled = false;
                        HTMLFormElement.prototype.submit.call(form);
                    });
                });
                return false;
            }

            // Show loading state for regular submission
            isSubmitting = true;
            document.getElementById('btnText').classList.add('hidden');
            document.getElementById('btnLoading').classList.remove('hidden');
        });
    </script>
}
